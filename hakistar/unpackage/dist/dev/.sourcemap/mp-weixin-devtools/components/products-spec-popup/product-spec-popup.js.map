{"version":3,"file":"product-spec-popup.js","sources":["product-spec-popup.vue","RDov5rqc5rqc54iq5a6g54mp5bCP56iL5bqPL3BldC1hcHAvbGl1bGl1emh1YS9jb21wb25lbnRzL3Byb2R1Y3RzLXNwZWMtcG9wdXAvcHJvZHVjdC1zcGVjLXBvcHVwLnZ1ZQ"],"sourcesContent":["<template>\r\n\t<up-popup :show=\"show\" closeable @close=\"handleClose\">\r\n\t\t<view class=\"spec-popup\">\r\n\t\t\t<view class=\"popup-header\">\r\n\t\t\t\t<image class=\"product-img\" :src=\"product.main_pic\" mode=\"aspectFill\"></image>\r\n\t\t\t\t<view class=\"product-info\">\r\n\t\t\t\t\t<view class=\"price\">￥{{finalPrice}}</view>\r\n\t\t\t\t\t<view class=\"selected\">已选：{{selectedSpec || \"请选择规格\"}}</view>\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t\t<view class=\"spec-content\">\r\n\t\t\t\t<view class=\"spec-group\" v-for=\"group in specList\" :key=\"group.attr_id\">\r\n\t\t\t\t\t<view class=\"group-title\">{{group.attr_name}}</view>\r\n\t\t\t\t\t<view class=\"spec-items\">\r\n\t\t\t\t\t\t<view class=\"spec-item\" v-for=\"(item,index) in group.values\" :key=\"item.value_id\"\r\n\t\t\t\t\t\t\t:class=\"{active:selectedSpecs[group.attr_id]===item.value_id}\"\r\n\t\t\t\t\t\t\t@click=\"selectSpec(group.attr_id,item.value_id,item.value)\">\r\n\t\t\t\t\t\t\t{{item.value}}\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t\t<view class=\"popup-footer\">\r\n\t\t\t\t<view class=\"quantity\">\r\n\t\t\t\t\t<text>数量</text>\r\n\t\t\t\t\t<view class=\"quantity-control\">\r\n\t\t\t\t\t\t<view class=\"minus\" @click=\"decrease\">-</view>\r\n\t\t\t\t\t\t<view class=\"count\">{{quantity}}</view>\r\n\t\t\t\t\t\t<view class=\"plus\" @click=\"increase\">+</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</view>\r\n\t\t\t\t<view class=\"confirm-ok\" v-if=\"showOk\" @click=\"handleOk\">确定</view>\r\n\t\t\t\t<view class=\"confirm-btn\" @click=\"confirmSpec\">加购</view>\r\n\t\t\t</view>\r\n\t\t</view>\r\n\t</up-popup>\r\n</template>\r\n\r\n<script lang=\"ts\" setup>\r\n\timport { watch, ref, reactive, computed } from \"vue\";\r\n\timport { get,post} from \"../../utils/http\";\r\n\timport {useSpecStore} from \"../../store/spec\";\r\n\tinterface ProductItem {\r\n\t\tid : number;\r\n\t\tname : string;\r\n\t\tprice : string;\r\n\t\to_price : string;\r\n\t\tstock : number;\r\n\t\tcategory_id : number;\r\n\t\tmain_pic : string;\r\n\t\tdesc : string\r\n\t}\r\n\t//规格分类值\r\n\tinterface SpecValue {\r\n\t\tvalue_id : number,\r\n\t\tvalue : string;\r\n\t\tmultiple : string\r\n\t}\r\n\t//规格分类名称\r\n\tinterface SpecArr {\r\n\t\tattr_id : number,\r\n\t\tattr_name : string;\r\n\t\tvalues : SpecValue[]\r\n\t}\r\n\tconst specStore=useSpecStore()\r\n\tconst props = defineProps<{ show : boolean, product : ProductItem,showOk:boolean }>()\r\n\tconst emit = defineEmits([\"close\"])\r\n\r\n\t//获取商品规格\r\n\twatch(() => props.show, (newVal) => {\r\n\t\tif (newVal) {\r\n\t\t\tgetSpec()\r\n\t\t}\r\n\t})\r\n\tconst specList = ref<SpecArr[]>([])//规格数据\r\n\tconst getSpec = async () => {\r\n\t\ttry {\r\n\t\t\tconst res : any = await get(\"/cart/getSpec\", { id: props.product.id })\r\n\t\t\t\r\n\t\t\tspecList.value = res || [] //返回结果一定是数组\r\n\t\t\tif (!res) {\r\n\t\t\t\thandleClose() //关闭弹窗\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tuni.navigateTo({\r\n\t\t\t\t\t\turl: \"/pages/login/login\"\r\n\t\t\t\t\t})\r\n\t\t\t\t}, 500)\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tuni.__f__('log','at components/products-spec-popup/product-spec-popup.vue:90',error)\r\n\t\t}\r\n\t}\r\n\tconst selectedSpecs = reactive<{ [key : string] : number }>({}) //{\"1\":5,\"2\":1} 存储选中的规格值id  \r\n\tconst selectedTexts = reactive<{ [key : string] : string }>({}) //{\"1\":\"5kg\",\"2\":\"鸡肉味\"}\r\n\tconst selectedSpec = ref<string>(\"\") //已选规格字符串 如 2kg，鸡肉味\r\n\tconst selectSpec = (attr_id : number, value_id : number, value : string) => {\r\n\t\tselectedSpecs[attr_id] = value_id;\r\n\t\tselectedTexts[attr_id] = value;\r\n\t\tselectedSpec.value = Object.values(selectedTexts).join(\"，\")\r\n\t}\r\n\r\n\tconst handleClose = () => {\r\n\t\temit(\"close\");\r\n\t\t//重置数据\r\n\t\tObject.keys(selectedSpecs).forEach(key => delete selectedSpecs[key]);\r\n\t\tObject.keys(selectedTexts).forEach(key => delete selectedTexts[key]);\r\n\t\tselectedSpec.value = \"\"\r\n\t}\r\n\t//商品数量\r\n\tconst quantity = ref<number>(1)\r\n\tconst increase = () => {\r\n\t\tquantity.value++\r\n\t}\r\n\tconst decrease = () => {\r\n\t\tif (quantity.value > 1) {\r\n\t\t\tquantity.value--\r\n\t\t}\r\n\t}\r\n\tconst finalPrice = computed(() => {\r\n\t\t//find return一个条件，返回符合条件的这个数据\r\n\t\tlet price : number = Number(props.product.price)\r\n\t\tif(specList.value.length){ //数组有数据再循环\r\n\t\t\tspecList.value.forEach(group => {\r\n\t\t\t\tconst selected = group.values.find(item => selectedSpecs[group.attr_id] === item.value_id);\r\n\t\t\t\tuni.__f__('log','at components/products-spec-popup/product-spec-popup.vue:125',\"选中的数据\", selected)\r\n\t\t\t\tif (selected?.multiple) {\r\n\t\t\t\t\tprice *= Number(selected.multiple)\r\n\t\t\t\t}\t\t\t\r\n\t\t\t})\r\n\t\t}\t\t\r\n\t\treturn price * quantity.value\r\n\t})\r\n\t//调用加入购物车接口\r\n\tconst confirmSpec= async ()=>{\r\n\t\t//判断该商品的所有规格是否都有选择\r\n\t\t//every 用于检测数组中的左右元素是否都符合指定条件\r\n\t\tconst allSelected=specList.value.every(group=>selectedSpecs[group.attr_id]) //判断商品的所有规格是否都能在已选规格中找到对应的\r\n\t\tif(!allSelected){\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle:\"请选择完整规格\",\r\n\t\t\t\ticon:\"error\"\r\n\t\t\t})\r\n\t\t\treturn \r\n\t\t}\r\n\t\ttry {\r\n\t\t\tconst res=await post(\"/cart/addCart\",{\r\n\t\t\t\tproduct_id:props.product.id,\r\n\t\t\t\tname:props.product.name,\r\n\t\t\t\tprice:finalPrice.value,\r\n\t\t\t\tcount:quantity.value,\r\n\t\t\t\tspec:selectedSpec.value,\r\n\t\t\t\tmain_pic:props.product.main_pic\r\n\t\t\t})\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle:\"加购成功\",\r\n\t\t\t\ticon:\"success\"\r\n\t\t\t})\r\n\t\t\tspecStore.setSpec(\"\")\r\n\t\t\tspecStore.setCount(1)\r\n\t\t\thandleClose()\r\n\t\t} catch (error) {\r\n\t\t\t//TODO handle the exception\r\n\t\t\tuni.__f__('error','at components/products-spec-popup/product-spec-popup.vue:163',error)\r\n\t\t}\r\n\t}\r\n\t//点击确定按钮，将数据存在pinia中\r\n\tconst handleOk=()=>{\r\n\t\tconst allSelected=specList.value.every(group=>selectedSpecs[group.attr_id]) //判断商品的所有规格是否都能在已选规格中找到对应的\r\n\t\tif(!allSelected){\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle:\"请选择完整规格\",\r\n\t\t\t\ticon:\"error\"\r\n\t\t\t})\r\n\t\t\treturn \r\n\t\t}\r\n\t\tspecStore.setSpec(selectedSpec.value)\r\n\t\tspecStore.setCount(quantity.value)\r\n\t\thandleClose()\r\n\t}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n\t.spec-popup {\r\n\t\tpadding: 30rpx;\r\n\r\n\t\t.popup-header {\r\n\t\t\tdisplay: flex;\r\n\t\t\talign-items: center;\r\n\t\t\tmargin-bottom: 30rpx;\r\n\r\n\t\t\t.product-img {\r\n\t\t\t\twidth: 160rpx;\r\n\t\t\t\theight: 160rpx;\r\n\t\t\t\tborder-radius: 12rpx;\r\n\t\t\t\tmargin-right: 20rpx;\r\n\t\t\t}\r\n\r\n\t\t\t.product-info {\r\n\t\t\t\tflex: 1;\r\n\r\n\t\t\t\t.price {\r\n\t\t\t\t\tcolor: #ff4d4f;\r\n\t\t\t\t\tfont-size: 36rpx;\r\n\t\t\t\t\tfont-weight: bold;\r\n\t\t\t\t\tmargin-bottom: 10rpx;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.selected {\r\n\t\t\t\t\tcolor: #666;\r\n\t\t\t\t\tfont-size: 28rpx;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t.spec-content {\r\n\t\t\tmax-height: 600rpx;\r\n\t\t\toverflow-y: auto;\r\n\r\n\t\t\t.spec-group {\r\n\t\t\t\tmargin-bottom: 30rpx;\r\n\r\n\t\t\t\t.group-title {\r\n\t\t\t\t\tfont-size: 28rpx;\r\n\t\t\t\t\tcolor: #333;\r\n\t\t\t\t\tmargin-bottom: 20rpx;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.spec-items {\r\n\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\tflex-wrap: wrap;\r\n\t\t\t\t\tgap: 20rpx;\r\n\r\n\t\t\t\t\t.spec-item {\r\n\t\t\t\t\t\tpadding: 10rpx 30rpx;\r\n\t\t\t\t\t\tborder: 2rpx solid #ddd;\r\n\t\t\t\t\t\tborder-radius: 30rpx;\r\n\t\t\t\t\t\tfont-size: 26rpx;\r\n\t\t\t\t\t\tcolor: #666;\r\n\r\n\t\t\t\t\t\t&.active {\r\n\t\t\t\t\t\t\tcolor: #ffce2c;\r\n\t\t\t\t\t\t\tborder-color: $uni-color-primary;\r\n\t\t\t\t\t\t\tbackground-color: rgba(255, 206, 44, 0.1);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t.popup-footer {\r\n\t\t\tdisplay: flex;\r\n\t\t\talign-items: center;\r\n\t\t\tjustify-content: space-between;\r\n\t\t\tmargin-top: 30rpx;\r\n\t\t\tpadding-top: 30rpx;\r\n\t\t\tborder-top: 2rpx solid #eee;\r\n\r\n\t\t\t.quantity {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\r\n\t\t\t\ttext {\r\n\t\t\t\t\tmargin-right: 20rpx;\r\n\t\t\t\t\tfont-size: 28rpx;\r\n\t\t\t\t\tcolor: #333;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.quantity-control {\r\n\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\talign-items: center;\r\n\r\n\t\t\t\t\t.minus,\r\n\t\t\t\t\t.plus {\r\n\t\t\t\t\t\twidth: 60rpx;\r\n\t\t\t\t\t\theight: 60rpx;\r\n\t\t\t\t\t\tborder: 2rpx solid #ddd;\r\n\t\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\t\talign-items: center;\r\n\t\t\t\t\t\tjustify-content: center;\r\n\t\t\t\t\t\tfont-size: 32rpx;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t.count {\r\n\t\t\t\t\t\twidth: 80rpx;\r\n\t\t\t\t\t\theight: 60rpx;\r\n\t\t\t\t\t\ttext-align: center;\r\n\t\t\t\t\t\tborder-top: 2rpx solid #ddd;\r\n\t\t\t\t\t\tborder-bottom: 2rpx solid #ddd;\r\n\t\t\t\t\t\tline-height: 60rpx;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t.confirm-btn {\r\n\t\t\t\twidth: 220rpx;\r\n\t\t\t\theight: 80rpx;\r\n\t\t\t\tbackground-color: $uni-color-primary;\r\n\t\t\t\tcolor: #fff;\r\n\t\t\t\tborder-radius: 40rpx;\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tjustify-content: center;\r\n\t\t\t\tfont-size: 28rpx;\r\n\t\t\t}\r\n\t\t\t.confirm-ok{\r\n\t\t\t\twidth: 140rpx;\r\n\t\t\t\theight: 80rpx;\r\n\t\t\t\tborder: $uni-color-primary 1px solid;\r\n\t\t\t\tcolor: $uni-color-primary;\r\n\t\t\t\tborder-radius: 80rpx;\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tjustify-content: center;\r\n\t\t\t\tfont-size: 28rpx;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</style>","import Component from 'D:/溜溜爪宠物小程序/pet-app/liuliuzhua/components/products-spec-popup/product-spec-popup.vue'\nwx.createComponent(Component)"],"names":["useSpecStore","watch","ref","get","uni","reactive","computed","post"],"mappings":"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"}